{% extends "base.html" %}

{% block content %}
    {{ super() }}
    <div class="container-fluid">
        <div class="col-lg-12">
            {% if stream %}
                 <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">{{ stream.stream_id.name }}</h4>
                        </div>
                        <div class="panel-body">
                            <p><strong>Meta data: </strong>{% for v in stream.stream_id.meta_data %}{{ v[0] }}=<strong>{{ v[1] }}</strong>{{ "," if not loop.last }}&nbsp{% endfor %}</p>
                            <p><strong>Channel: </strong>{{ stream.channel.__class__.__name__ }}: "{{ stream.channel.channel_id }}"</p>
                            <p><strong>Calculated intervals: </strong>{{ stream.calculated_intervals | map('string') | list | join(', ') }}</p>
                            <p><strong>Last item: </strong>{% if stream.calculated_intervals %}<br/>&emsp;Timestamp: {{ stream.window().last().timestamp }}<br/>&emsp;Value: {{ stream.window().last().value }}{% else %}No calculations have been performed.{% endif %}</p>
                            <p><a href="{{ url_for('stream', channel=stream.channel.channel_id, name=stream.stream_id.name, meta_data=dict(stream.stream_id.meta_data), mimetype='json', func='tail', parameters=[('int', '10')]) }}">JSON (last 10 items)</a></p>
                            <p><a href="{{ url_for('stream', channel=stream.channel.channel_id, name=stream.stream_id.name, meta_data=dict(stream.stream_id.meta_data), mimetype='json', func='items') }}">JSON (all)</a></p>
                        </div>
                    </div>
                    <div id="myDiv" style="col-lg-12 height: 400px;"><!-- Plotly chart will be drawn inside this DIV --></div>
{#                    <div id="container" style="width:100%; height:400px;"></div>#}
                 {% include "stream_view.html" %}
            {% else %}
                <p>No streams found.</p>
            {% endif %}
            {% if error %}
                <h4>{{ error.__class__.__name__ }}</h4>
                {% if error.message %}
                    <p>{{ error.message }}</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {% set data = url_for('stream', channel=stream.channel.channel_id, name=stream.stream_id.name, meta_data=dict(stream.stream_id.meta_data), mimetype='json', func='items') %}
    {{ super() }}
    <script type="text/javascript" src="{{ url_for('bower.static', filename='plotlyjs/plotly.js') }}"></script>
{#    <script type="text/javascript" src="{{ url_for('bower.static', filename='highstock/highstock.js') }}"></script>#}
{#    <script type="text/javascript" src="{{ url_for('bower.static', filename='highstock/js/themes/gray.js') }}"></script>#}
    <script language="JavaScript">

    Plotly.d3.json('{{ data }}', function(rows){
    var trace = {
          type: 'scatter',                    // set the chart type
          mode: 'lines',                      // connect points with lines
          x: rows.map(function(row){          // set the x-data
            return row.timestamp;
          }),
          y: rows.map(function(row){          // set the x-data
            return row.value;
          }),
          line: {                             // set the width of the line.
            width: 1
          }
    };

    var layout = {
      yaxis: {title: "value"},       // set the y axis title
      xaxis: {
        showgrid: false,                  // remove the x-axis grid lines
        tickformat: "%Y-%m-%d %H %M %S"
      },
      margin: {                           // update the left, bottom, right, top margin
        l: 40, b: 200, r: 10, t: 20
      }
    };

    Plotly.plot(document.getElementById('myDiv'), [trace], layout, {showLink: false});
});


{#    $.getJSON('{{ data }}',  function(data) {#}
{#        debugger;#}
{#        data = $.map(data, function (d) { return [Date.parse(d.timestamp), d.value]; });#}
{#        $(function () {#}
{#            var chart1; // globally available#}
{#            $(function () {#}
{#                chart1 = Highcharts.stockChart('container', {#}
{#                    title: {#}
{#                        text: '{{ stream.stream_id.name }}'#}
{#                    },#}
{##}
{#                    subtitle: {#}
{#                        text: '{{ dict(stream.stream_id.meta_data) | tojson }}'#}
{#                    },#}
{##}
{#                    xAxis: {#}
{#                        gapGridLineWidth: 0#}
{#                    },#}
{##}
{#                    rangeSelector: {#}
{#                        buttons: [{#}
{#                            type: 'hour',#}
{#                            count: 1,#}
{#                            text: '1h'#}
{#                        }, {#}
{#                            type: 'day',#}
{#                            count: 1,#}
{#                            text: '1D'#}
{#                        }, {#}
{#                            type: 'week',#}
{#                            count: 7,#}
{#                            text: '7D'#}
{#                        }, {#}
{#                            type: 'all',#}
{#                            count: 1,#}
{#                            text: 'All'#}
{#                        }],#}
{#                        selected: 1,#}
{#                        inputEnabled: false#}
{#                    },#}
{##}
{#                    series: [{#}
{#                        name: 'value',#}
{#                        type: 'area',#}
{#                        data: data,#}
{#                        gapSize: 5,#}
{#                        tooltip: {#}
{#                            valueDecimals: 2#}
{#                        },#}
{#                        fillColor: {#}
{#                            linearGradient: {#}
{#                                x1: 0,#}
{#                                y1: 0,#}
{#                                x2: 0,#}
{#                                y2: 1#}
{#                            },#}
{#                            stops: [#}
{#                                [0, Highcharts.getOptions().colors[0]],#}
{#                                [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]#}
{#                            ]#}
{#                        },#}
{#                        threshold: null#}
{#                    }]#}
{#                });#}
{#            });#}
{#        });#}
{#    });#}
    </script>
{% endblock %}